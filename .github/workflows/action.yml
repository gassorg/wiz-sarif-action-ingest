name: SARIF to Wiz - Batch Convert & Upload
description: A reusable workflow to convert SARIF files to Wiz format and upload them to the Wiz platform. This workflow can be called from other workflows or triggered on pull request merges.

on:

  workflow_call:
    inputs:
      sarif_input_dir:
        required: true
        type: string
        default: '.sarif-reports'
      repository_name:
        required: false
        type: string
      repository_url:
        required: false
        type: string
      branch_name:
        required: false
        type: string
      cve_only:
        required: false
        type: boolean
        default: false
      wiz_api_config:
        required: false
        type: string
        default: 'uploader_config.json'
    secrets:
      WIZ_CLIENT_ID:
        required: true
      WIZ_CLIENT_SECRET:
        required: true
      WIZ_TOKEN_URL:
        required: true
      WIZ_API_ENDPOINT_URL:
        required: true

jobs:
  convert-and-upload:
    runs-on: ubuntu-latest
    
    env:
      # Wiz API Credentials from GitHub Secrets
      WIZ_CLIENT_ID: ${{ secrets.WIZ_CLIENT_ID }}
      WIZ_CLIENT_SECRET: ${{ secrets.WIZ_CLIENT_SECRET }}
      WIZ_TOKEN_URL: ${{ secrets.WIZ_TOKEN_URL }}
      WIZ_API_ENDPOINT_URL: ${{ secrets.WIZ_API_ENDPOINT_URL }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create output directory
        run: mkdir -p ./wiz-scan-results

      - name: Convert SARIF files to Wiz format
        run: |
          python3 sarif_to_wiz_converter.py \
            --input-dir "${{ github.event.inputs.sarif_input_dir || '.sarif-reports' }}" \
            --output-dir ./wiz-scan-results \
            ${{ github.event.inputs.repository_name && format('--repository-name {0}', github.event.inputs.repository_name) || '' }} \
            ${{ github.event.inputs.repository_url && format('--repository-url {0}', github.event.inputs.repository_url) || '' }} \
            ${{ github.event.inputs.branch_name && format('--branch-name {0}', github.event.inputs.branch_name) || '' }} \
            ${{ github.event.inputs.cve_only && '--cve-only' || '' }} \
            --verbose
        continue-on-error: false

      - name: Verify Wiz files were created
        run: |
          if [ -z "$(find ./wiz-scan-results -name '*.wiz.json' 2>/dev/null)" ]; then
            echo "âŒ No Wiz JSON files were created from SARIF conversion"
            exit 1
          fi
          echo "âœ“ Successfully created Wiz JSON files:"
          find ./wiz-scan-results -name '*.wiz.json' -type f

      - name: Upload to Wiz platform
        run: |
          # Environment variables are automatically available (WIZ_CLIENT_ID, WIZ_CLIENT_SECRET, etc.)
          # Config file is optional - upload_security_scan.py will use env vars or fall back to config file
          config_option=""
          if [ -f "${{ github.event.inputs.wiz_api_config || 'uploader_config.json' }}" ]; then
            config_option="-c ${{ github.event.inputs.wiz_api_config || 'uploader_config.json' }}"
          fi
          
          # Find all converted Wiz files and upload them
          for wiz_file in ./wiz-scan-results/**/*.wiz.json; do
            if [ -f "$wiz_file" ]; then
              echo "ðŸ“¤ Uploading: $wiz_file"
              python3 upload_security_scan.py $config_option -f "$wiz_file" || {
                echo "âš ï¸ Failed to upload $wiz_file, continuing with next file..."
                continue
              }
            fi
          done
          echo "âœ“ Upload process completed"

      - name: Generate summary report
        if: always()
        run: |
          echo "## SARIF to Wiz Conversion & Upload Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Conversion Results" >> $GITHUB_STEP_SUMMARY
          echo "- Input directory: ${{ github.event.inputs.sarif_input_dir || '.sarif-reports' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Output directory: ./wiz-scan-results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Converted Files" >> $GITHUB_STEP_SUMMARY
          find ./wiz-scan-results -name '*.wiz.json' -type f | while read file; do
            size=$(ls -lh "$file" | awk '{print $5}')
            echo "- $(basename $file) ($size)" >> $GITHUB_STEP_SUMMARY
          done || echo "No files converted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          [ -n "${{ github.event.inputs.repository_name }}" ] && echo "- Repository: ${{ github.event.inputs.repository_name }}" >> $GITHUB_STEP_SUMMARY || true
          [ -n "${{ github.event.inputs.branch_name }}" ] && echo "- Branch: ${{ github.event.inputs.branch_name }}" >> $GITHUB_STEP_SUMMARY || true
          [ "${{ github.event.inputs.cve_only }}" = "true" ] && echo "- CVE-only mode: Enabled" >> $GITHUB_STEP_SUMMARY || true
